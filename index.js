const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const qrcodeTerminal = require('qrcode-terminal');
const QRCode = require('qrcode');
const { Client, LocalAuth } = require('whatsapp-web.js');
const axios = require('axios');
const fs = require('fs');
const path = require('path');

const app = express();
const port = process.env.PORT || 3000;

app.use(cors({ origin: 'https://backoff.travel4you.ma' }));
app.use(express.json());
app.use(bodyParser.json());

// Connection state
let isConnected = false;
let isClientReady = false;
let lastQrCode = null;

const authPath = path.join(__dirname, '.wwebjs_auth');
if (!fs.existsSync(authPath)) fs.mkdirSync(authPath);


// Init WhatsApp client
const client = new Client({
    authStrategy: new LocalAuth({ clientId: "default" }),
    puppeteer: {
        headless: true,
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-gpu',
            '--single-process',
            '--no-zygote'
        ]
    }
});

// QR Code generated
client.on('qr', qr => {
    console.log('üìå QR Code re√ßu, scanner avec WhatsApp :');
    qrcodeTerminal.generate(qr, { small: true });
    QRCode.toDataURL(qr, (err, url) => {
        if (err) console.error('‚ùå Erreur g√©n√©ration QR code:', err);
        else lastQrCode = url;
    });
});
client.on('authenticated', () => {
    console.log('üîê Authentifi√© avec succ√®s');
});
// Auth failure
client.on('auth_failure', msg => {
    console.error('‚ùå √âchec d\'authentification:', msg);
    isConnected = false;
    lastQrCode = null;
});

// Ready
client.on('ready', async () => {
    console.log('‚úÖ Le client est pr√™t ! Connexion √©tablie.');
    isConnected = true;
    isClientReady = true;
    lastQrCode = null;

    try {
        await syncAllContacts();
        console.log('üîÑ Synchronisation initiale termin√©e.');
    } catch (err) {
        console.error('‚ùå Erreur syncAllContacts:', err.message);
    }

    // Process unread messages
    try {
        const chats = await client.getChats();
        for (const chat of chats) {
            if (chat.unreadCount > 0) {
                const messages = await chat.fetchMessages({ limit: chat.unreadCount });
                for (const msg of messages) await processMessageAndSendToDjango(msg);
                await chat.sendSeen();
            }
        }
        console.log('üì© Messages non lus trait√©s.');
    } catch (err) {
        console.error('‚ùå Erreur traitement messages non lus:', err);
    }

    // Sync contacts every 2 minutes
    setInterval(syncAllContacts, 2 * 60 * 1000);
});



client.on('disconnected', reason => {
    console.log('‚ö†Ô∏è D√©connect√© de WhatsApp:', reason);
    isConnected = false;
    isClientReady = false;
    setTimeout(() => client.initialize(), 5000);
});

// Status endpoint
app.get("/whatsapp-status", (req, res) => {
    console.log("üì° Status request =>", { connected: isConnected, hasQR: !!lastQrCode });
    res.json({ connected: isConnected, hasQR: !!lastQrCode, qr: lastQrCode });
});

async function safeDestroy() {
    try {
        await client.destroy();
    } catch (e) {
        console.warn('Erreur lors de destroy, tentative dans 2s', e.message);
        await new Promise(res => setTimeout(res, 2000));
        await client.destroy();
    }
}

// Disconnect endpoint
app.post("/whatsapp-disconnect", async (req, res) => {
    try {
        await safeDestroy();
        isConnected = false;
        lastQrCode = null;
        setTimeout(() => {
            client.initialize();
        }, 2000); // 2 secondes, ajustable
        res.json({ status: "disconnected" });
    } catch (err) {
        res.status(500).json({ error: err.message });
    }
});

// Django API URL
const DJANGO_API_URL = 'https://ts.travel4you.ma/api/receive-message/';

// Process and forward incoming messages
async function processMessageAndSendToDjango(msg) {
    if (msg.fromMe) return;

    // Ajout d'un log pour confirmer que la fonction est appel√©e
    console.log(`[processMessageAndSendToDjango] Traitement d'un message de ${msg.from}`);

    let messageBody = '';

    if (msg.hasMedia) {
        const mediaType = msg.type;
        console.log(`üì© Nouveau m√©dia re√ßu de ${msg.from}. Type: ${mediaType}`);
        const typeMap = {
            image: 'Image',
            audio: 'Audio',
            video: 'Vid√©o',
            document: 'Document',
            ptt: 'Message vocal',
            sticker: 'Sticker'
        };
        messageBody = typeMap[mediaType] || 'Autre m√©dia';
    } else {
        const textMessage = msg.body.trim();
        if (!textMessage) {
            console.log(`‚ö†Ô∏è Message vide re√ßu de ${msg.from}. Ignor√©.`);
            return;
        }
        console.log(`üí¨ Nouveau texte re√ßu de ${msg.from}: "${textMessage}"`);
        messageBody = textMessage;
    }

    try {
        const response = await axios.post(DJANGO_API_URL, {
            sender_number: msg.from,
            message_body: messageBody
        }, { headers: { 'Content-Type': 'application/json' } });

        if (response.status >= 200 && response.status < 300) {
            console.log("‚úÖ Envoy√© √† Django:", response.data);
        } else {
            console.warn(`‚ö†Ô∏è Statut inattendu ${response.status}:`, response.data);
        }
    } catch (error) {
        if (error.response) {
            console.error(`‚ùå Django error ${error.response.status}:`, error.response.data);
        } else if (error.request) {
            console.error(`‚ùå Connexion Django √©chou√©e:`, error.message);
        } else {
            console.error("‚ùå Erreur inattendue:", error.message);
        }
    }
}

// Listen to messages
client.on('message', processMessageAndSendToDjango);

// On ready, process unread messages
client.on('ready', async () => {
    console.log('üîç Recherche des messages non lus...');
    try {
        const chats = await client.getChats();
        for (const chat of chats) {
            if (chat.unreadCount > 0) {
                console.log(`üì• ${chat.unreadCount} messages non lus de ${chat.name} (${chat.id.user})`);
                const messages = await chat.fetchMessages({ limit: chat.unreadCount });
                for (const msg of messages) {
                    await processMessageAndSendToDjango(msg);
                }
                await chat.sendSeen();
                console.log(`‚úÖ ${chat.name} marqu√© comme lu.`);
            }
        }
    } catch (error) {
        console.error("‚ùå Erreur r√©cup√©ration messages non lus:", error);
    }
    console.log('‚úÖ Traitement termin√©.');
});

// Relance paiement
const sendRelancePayer = async () => {
    try {
        const response = await axios.get('https://ts.travel4you.ma/paiement-tours/clients-a-relancer/');
        const clients = response.data;

        for (const clientData of clients) {
            const numero = clientData.client_phone.replace(/\D/g, '');
            const message = `Bonjour ${clientData.client_name}, il vous reste ${clientData.balance_remaining} MAD √† payer pour les services : ${clientData.tour_title}. Merci de r√©gulariser votre situation.`;

            try {
                await client.sendMessage(`${numero}@c.us`, message);
                console.log(`‚úÖ Message envoy√© √† ${numero}`);
            } catch (err) {
                console.error(`‚ùå Erreur envoi ${numero}:`, err.message);
            }
        }
    } catch (err) {
        console.error('‚ùå Erreur r√©cup√©ration paiement:', err.message);
    }
};

app.get('/send-relance-payer', (req, res) => {
    sendRelancePayer();
    res.json({ status: 'Relances paiement envoy√©es' });
});

app.post("/relance-pub", async (req, res) => {
    const { message, contacts } = req.body;

    if (!message || !message.trim()) {
        return res.status(400).json({ message: "Le message est requis." });
    }
    if (!Array.isArray(contacts) || contacts.length === 0) {
        return res.status(400).json({ message: "Aucun contact fourni." });
    }

    console.log(`üì¢ Envoi relance √† ${contacts.length} contacts...`);

    let sent = [];
    let failed = [];

    for (let number of contacts) {
        // Formatage international si n√©cessaire
        let phone = number.replace(/\D/g, ""); // supprimer tout sauf chiffres
        if (!phone.endsWith("@c.us")) {
            phone = `${phone}@c.us`;
        }

        try {
            await client.sendMessage(phone, message);
            console.log(`‚úÖ Message envoy√© √† ${number}`);
            sent.push(number);
        } catch (err) {
            console.error(`‚ùå √âchec envoi √† ${number}, err.message`);
            failed.push(number);
        }
    }

    return res.json({
        message: "Relance termin√©e",
        sentCount: sent.length,
        failedCount: failed.length,
        sent,
        failed,
    });
});

const DJANGO_SYNC_CONTACTS_URL = 'https://ts.travel4you.ma/api/sync_contacts/sync_contacts/';

/**
 * Synchronise tous les chats de la liste WhatsApp vers l'API Django.
 * L'API Django est cens√©e g√©rer l'ajout et la mise √† jour des contacts.
 */
const syncAllContacts = async () => {
    console.log("D√©marrage de la synchronisation des contacts WhatsApp...");
    // Ajouter cette v√©rification pour √©viter l'erreur
    if (!client || !client.info) {
        console.error("‚ùå Le client n'est pas pr√™t pour la synchronisation.");
        return;
    }
    try {
        const chats = await client.getChats();
        const contactsToSync = [];

        for (const chat of chats) {
            if (chat.isGroup) continue;

            const number = chat.id.user;
            contactsToSync.push({
                number: number,
                direction: "sync"
            });
        }
        console.log("Type envoy√© √† Django:", Array.isArray(contactsToSync));
        console.log("Premier contact:", contactsToSync[0]);

        if (contactsToSync.length > 0) {
            console.log(`Envoi de ${contactsToSync.length} contacts au serveur Django...`);

            const response = await axios.post(
                DJANGO_SYNC_CONTACTS_URL,
                contactsToSync,
                { headers: { "Content-Type": "application/json", "Accept": "application/json" } }
            );

            console.log(`‚úÖ Synchronisation termin√©e.`, response.data);
        } else {
            console.log("Aucun contact √† synchroniser.");
        }
    } catch (err) {
        console.error('‚ùå Erreur de synchronisation globale:', err.message);
    }
};

// Endpoint pour d√©clencher manuellement la synchronisation
app.get('/whatsapp-sync-contacts', async (req, res) => {
    if (!isClientReady) {
        return res.status(400).json({
            status: 'error',
            message: 'Client WhatsApp non pr√™t. Veuillez scanner le QR code.'
        });
    }
    await syncAllContacts();
    res.json({ status: 'Synchronization completed.' });
});
// Start WhatsApp client
client.initialize();

// Start server
const actualPort = process.env.PORT || 3000;
app.listen(actualPort, () => {
    console.log(`üöÄ Serveur √©coute sur http://localhost:${actualPort}`);
    console.log(`Listening on port ${actualPort}`);
});
